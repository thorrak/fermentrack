.. include:: ../global.rst

Tilt Setup
==========

To associate your a Tilt with Fermentrack, simply place the Tilt near a Raspberry Pi 3B or newer, running Fermentrack. Place the Tilt at an angle (not vertical or horizontal) to wake it up and the Pi running Fermentrack will automatically detect the Tilt (The Tilt enters a sleep mode when horizontal or vertical).

#. From the main Fermentrack dashboard, click on "Add new gravity sensor"
#. Click on the Tilt icon
#. Enter a name for the Tilt hydrometer you are adding, select the temperature units you wish to use, and select the color of the circuit board on the Tilt. You also want to specify if you are using a direct Bluetooth connection (default, included) to your Pi, or using a TiltBridge bluetooth to WiFi adapter (requires additional hardware).

You will return to the Dashboard and Fermentrack will notify you that a new tilt sensor was added.

Tilt Settings
-------------

After adding the Tilt to Fermentrack, you are returned to the Gravity Sensors dashboard. Right now, the Tilt is running in unassociated mode in Fermentrack, meaning it is handled as its own device- not integrated with the BrewPi controller. Clicking on the device you just added will bring you into a screen where you can further configure and customize that Tilt sensor. From this page, you can `Manage Sensor`_, `Load Prior Log`_, and `Assign Device`_.

Manage Sensor
~~~~~~~~~~~~~

From the sensor dashboard, click on Manage Sensor. This page will show you the current settings running on the Tilt sensor, allow you to add manual calibration points, as well as allow you to perform a `Guided Calibration`_. The B, C, and D coefficients shown are automatically applied/updated after running a guided calibration. You can also remove this sensor from Fermentrack at the bottom of the page.

Load Prior Log
~~~~~~~~~~~~~~

This button allows you to view prior logs generated by the Tilt sensor. This will bring up a window with available logs. You can click on the log name to view the graph in the browser, or click "View Full CSV" to download the csv file that holds the raw data for the graph. You can also choose "Delete" to delete the log. Viewing a previous graph does not stop Fermentrack from collecting data from the Tilt on the active log. You can return to the active log by clicking the "Load Prior Log" button and then "Return to Active Log".

Assign Device
~~~~~~~~~~~~~
See `Integrating with BrewPi`_

Logging/Visualization
---------------------

To start logging data points from your Tilt, click below the device name in the orange box. Enter a name for your log in the text field and click "Create Log & Start Logging". This will create a blank graph where your data points will begin to populate after a few moments of being collected. The page does not refresh automatically so you will have to manually refresh to see updates.

Add Data Point
~~~~~~~~~~~~~~

This button allows you to manually add a data point to the graph. What you enter here will appear on the graph at the time you enter it. You can use these data points to annotate times that you perform specific actions, such as racking to secondary, adding dry hops, etc.

Control Logging
~~~~~~~~~~~~~~~

This button will give you the option to stop logging data and return you to the dashboard.

Guided Calibration
------------------

This section should be prefixed by stating that the Tilt sensor is very well calibrated out of the box and these steps are completely optional. This could be useful if you suspect your Tilt of falling out of calibration and want to reconfirm accuracy.

Although Tilt devices seem to output specific gravity readings, they work by internally measuring the angle (tilt) of the device and applying an equation to convert this angle to the expected specific gravity. While we do not have the ability to edit or calibrate this conversion equation directly, we can apply a correction factor to the readings it provides to add additional accuracy to the specific gravity we log. For the mathematically inclined, this is done by determining the coefficients for an equation of a line that best fits your Tilt's measurements (bx^2 + cx + d). 

This process will guide you through creating sugar/water mixtures of known specific gravity and then seeing what specific gravity the Tilt reports from each. By the end of this process you will have collected 5 data points which Fermentrack will then use to derive your Tilt's conversion function. This data will be used to mathematically determine a coefficient to apply to your Tilt which result in the most accurate reading possible for future use. 

You will need a few pieces of equipment to complete this process:

* 4 lbs (2 kg) White Table Sugar
* Water
* 2 cup (500 ml) measuring cup (for mixing)
* 2+ gallon (or 6+ liter) bucket (does not need to be sanitized)
* Tilt Hydrometer
* Gram scale

Once you have assembled these supplies, click "Begin guided calibration".

Integrating with BrewPi
-----------------------
To integrate your Tilt logging with a BrewPi controller:

#. Select the "Assign Device" button from the Dashboard view
#. From the dropdown list, select the name of the controller you wish to associate the Tilt sensor with
#. Click "Attach sensor to controller"

Now, to view your Tilt sensor readings, navigate to the BrewPi controller dashboard. You will have to restart a log if you had one running before associating the Tilt with the BrewPi sensor. Now, any wort you ferment with this controller will incorporate the Tilt's temperature and gravity readings onto your graph. Once the Tilt (or any gravity sensor) is attached to a BrewPi controller, that controller dashboard will become the main method with which to interact with the Tilt, specifically for things like logging.


Troubleshooting Tilt Support
----------------------------

Tilt Hydrometer support relies on a number of components beyond those used for other functions in Fermentrack, and as a result is particularly sensitive to changes in the program environment on the device on which Fermentrack is installed. Testing has been added to Fermentrack to help diagnose some of these environmental issues if they happen to impact an installation.


Fixing Missing System Packages
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If there are system packages missing, you will unfortunately need to fix them manually. For Raspberry Pis running
Raspbian, here is how to fix this issue. For other OS's, please adapt these instructions as necessary

#. Log into your Raspberry Pi via as the `pi` user
#. Type `sudo apt-get update` and allow the package system to update
#. Type `sudo-apt-get upgrade` and follow the prompts to upgrade all installed packages
#. For each missing package identified by the test script, type `sudo apt-get install -y {package name}`
#. Allow each package to install. Repeat the previous step for all missing packages.



Fixing Missing/Incorrect Python Packages
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Although all Python packages should be automatically installed as part of the installation script, it is possible that
packages come out of sync for a variety of reasons. If you are missing packages they will need to be installed for
Fermentrack to properly interface with your Tilt.

.. todo:: Enrich this with steps for resolving missing Python packages



